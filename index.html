<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pixel Art Studio | Global Edition</title>
    <meta name="description" content="Free online Pixel Art maker for Minecraft and retro game assets.">

    <!-- 1. Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-04KW4917B3"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-ZFC0SL7NFQ');
    </script>

    <!-- 2. Google AdSense -->
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-2859402783329016"
     crossorigin="anonymous"></script>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">

    <style>
        body {
            font-family: 'Noto Sans TC', 'Inter', sans-serif;
            background-color: #0f172a;
            color: #e2e8f0;
            touch-action: none; 
            overflow: hidden; 
        }
        
        .checkerboard {
            background-image: 
                linear-gradient(45deg, #1e293b 25%, transparent 25%), 
                linear-gradient(-45deg, #1e293b 25%, transparent 25%), 
                linear-gradient(45deg, transparent 75%, #1e293b 75%), 
                linear-gradient(-45deg, transparent 75%, #1e293b 75%);
            background-size: 20px 20px;
            background-position: 0 0, 0 10px, 10px -10px, -10px 0px;
            background-color: #0f172a; 
        }

        .cursor-pan { cursor: grab; }
        .cursor-panning { cursor: grabbing !important; }
        .cursor-draw { cursor: crosshair; }
        
        .no-select {
            user-select: none;
            -webkit-user-select: none;
        }

        /* Custom Scrollbar */
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .custom-scroll::-webkit-scrollbar { width: 8px; }
        .custom-scroll::-webkit-scrollbar-track { background: #1e293b; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #475569; border-radius: 4px; }
    </style>
</head>
<body>

    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useCallback } = React;

        // --- Network Nav Component ---
        function NetworkNav() {
            return (
                <div className="bg-black/40 border-b border-slate-800 py-1.5 flex justify-center items-center gap-4 text-xs z-40 relative">
                    <span className="text-slate-500 font-medium">More Tools:</span>
                    <a href="https://snapglow.app" className="text-slate-300 hover:text-white hover:underline transition-colors flex items-center gap-1.5">
                        âœ¨ SnapGlow
                    </a>
                    <span className="text-slate-700">|</span>
                    <a href="#" className="text-indigo-400 font-bold hover:text-indigo-300 transition-colors flex items-center gap-1.5 pointer-events-none">
                        ğŸ¨ PixelRetro
                    </a>
                </div>
            );
        }

        // --- Translations ---
        const TRANSLATIONS = {
            'zh-TW': {
                title: 'Pixel Studio',
                tools: 'å·¥å…·',
                pencil: 'ç•«ç­† (P)',
                eraser: 'æ©¡çš®æ“¦ (E)',
                fill: 'æ²¹æ¼†æ¡¶ (F)',
                dropper: 'å¸ç®¡ (I)',
                grid: 'ç¶²æ ¼',
                zoom: 'ç¸®æ”¾',
                reset: 'é‡ç½®è¦–è§’',
                undo: 'å¾©åŸ',
                download: 'åŒ¯å‡ºåœ–ç‰‡',
                upload_title: 'åƒè€ƒåœ–ç‰‡',
                upload_desc: 'ä¸Šå‚³åœ–ç‰‡è½‰åƒç´ ',
                quick_size: 'å¿«é€Ÿå»ºç«‹ç•«å¸ƒ',
                custom_size: 'è‡ªè¨‚å°ºå¯¸',
                create: 'å»ºç«‹',
                width: 'å¯¬',
                height: 'é«˜',
                sponsor_scan: 'æƒæ\nè´ŠåŠ©',
                sponsor_title: 'å–œæ­¡é€™å€‹å·¥å…·å—ï¼Ÿ',
                sponsor_desc: 'é€™æ˜¯ä¸€å€‹å…è²»é–‹æºå°ˆæ¡ˆã€‚\næ‚¨å¯ä»¥è«‹æˆ‘å–æ¯å’–å•¡æ”¯æŒé–‹ç™¼ï¼',
                sponsor_btn: 'Buy me a coffee',
                sponsor_thanks: 'æ„Ÿè¬æ‚¨çš„å’–å•¡ï¼â˜•',
                confirm_new: 'å»ºç«‹æ–°ç•«å¸ƒï¼Ÿç•¶å‰é€²åº¦å°‡éºå¤±ã€‚',
                footer_privacy: 'éš±ç§æ¬Šæ”¿ç­–',
                footer_terms: 'æœå‹™æ¢æ¬¾',
                footer_contact: 'è¯çµ¡æˆ‘å€‘',
                footer_lang: 'èªè¨€',
                modal_close: 'é—œé–‰'
            },
            'en': {
                title: 'Pixel Studio',
                tools: 'Tools',
                pencil: 'Pencil (P)',
                eraser: 'Eraser (E)',
                fill: 'Bucket (F)',
                dropper: 'Picker (I)',
                grid: 'Grid',
                zoom: 'Zoom',
                reset: 'Reset View',
                undo: 'Undo',
                download: 'Export PNG',
                upload_title: 'Reference',
                upload_desc: 'Image to Pixel',
                quick_size: 'Quick Canvas',
                custom_size: 'Custom Size',
                create: 'Create',
                width: 'W',
                height: 'H',
                sponsor_scan: 'Scan to\nSupport',
                sponsor_title: 'Love this tool?',
                sponsor_desc: 'Free & Open Source.\nBuy me a coffee to support!',
                sponsor_btn: 'Buy me a coffee',
                sponsor_thanks: 'Thanks! â˜•',
                confirm_new: 'Create new canvas? Unsaved progress will be lost.',
                footer_privacy: 'Privacy Policy',
                footer_terms: 'Terms of Service',
                footer_contact: 'Contact Us',
                footer_lang: 'Language',
                modal_close: 'Close'
            }
        };

        // --- Legal Content ---
        const LEGAL_CONTENT = {
            'zh-TW': {
                privacy: `<h2>éš±ç§æ¬Šæ”¿ç­–</h2><p>æœ€å¾Œæ›´æ–°æ—¥æœŸï¼š2026å¹´</p><p>æ­¡è¿ä½¿ç”¨ Pixel Art Studioã€‚æˆ‘å€‘éå¸¸é‡è¦–æ‚¨çš„éš±ç§ã€‚</p><h3>1. è³‡è¨Šæ”¶é›†</h3><p>æœ¬ç¶²ç«™æ˜¯ä¸€å€‹ç´”å‰ç«¯æ‡‰ç”¨ç¨‹å¼ã€‚æ‚¨çš„æ‰€æœ‰ç•«ä½œæ•¸æ“šçš†å„²å­˜æ–¼æ‚¨çš„ç€è¦½å™¨æœ¬åœ°è¨˜æ†¶é«”ä¸­ï¼Œæˆ‘å€‘ä¸æœƒå°‡æ‚¨çš„ç•«ä½œä¸Šå‚³è‡³ä»»ä½•ä¼ºæœå™¨ã€‚</p><h3>2. Cookie ä½¿ç”¨</h3><p>æˆ‘å€‘ä½¿ç”¨ Google AdSense ä¾†é¡¯ç¤ºå»£å‘Šï¼Œé€™å¯èƒ½æœƒä½¿ç”¨ Cookies ä¾†æ ¹æ“šæ‚¨ä¹‹å‰çš„è¨ªå•è¨˜éŒ„æŠ•æ”¾å»£å‘Šã€‚</p>`,
                terms: `<h2>æœå‹™æ¢æ¬¾</h2><p>æœ€å¾Œæ›´æ–°æ—¥æœŸï¼š2026å¹´</p><h3>1. ä½¿ç”¨è¨±å¯</h3><p>æ‚¨å¯ä»¥å…è²»ä½¿ç”¨æœ¬å·¥å…·é€²è¡Œå€‹äººæˆ–å•†æ¥­å‰µä½œã€‚</p><h3>2. å…è²¬è²æ˜</h3><p>æœ¬å·¥å…·æŒ‰ã€ŒåŸæ¨£ã€æä¾›ï¼Œä¸æä¾›ä»»ä½•å½¢å¼çš„ä¿è­‰ã€‚é–‹ç™¼è€…ä¸å°å› ä½¿ç”¨æœ¬å·¥å…·é€ æˆçš„ä»»ä½•æ•¸æ“šä¸Ÿå¤±è² è²¬ã€‚</p>`,
                contact: `<h2>è¯çµ¡æˆ‘å€‘</h2><p>å¦‚æœæ‚¨æœ‰ä»»ä½•å•é¡Œã€å»ºè­°æˆ–ç™¼ç¾ Bugï¼Œæ­¡è¿é€éä»¥ä¸‹æ–¹å¼è¯çµ¡ï¼š</p><p>Email: SnapGlowApp@gmail.com</p>`
            },
            'en': {
                privacy: `<h2>Privacy Policy</h2><p>Last updated: 2026</p><p>Welcome to Pixel Art Studio. We value your privacy.</p><h3>1. Information Collection</h3><p>This website is a client-side application. All your data is stored locally in your browser memory. We do not upload your artwork to any servers.</p><h3>2. Cookies</h3><p>We use Google AdSense to serve ads, which may use cookies to serve ads based on your prior visits.</p>`,
                terms: `<h2>Terms of Service</h2><p>Last updated: 2026</p><h3>1. License</h3><p>You are free to use this tool for personal or commercial projects.</p><h3>2. Disclaimer</h3><p>The tool is provided "as is", without warranty of any kind. The developer is not liable for any data loss.</p>`,
                contact: `<h2>Contact Us</h2><p>If you have any questions, suggestions or bug reports, please contact us at:</p><p>Email: SnapGlowApp@gmail.com</p>`
            }
        };

        // --- Icons ---
        const Icons = {
            Pencil: () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M17 3a2.85 2.83 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5Z"/><path d="m15 5 4 4"/></svg>,
            Eraser: () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="m7 21-4.3-4.3c-1-1-1-2.5 0-3.4l9.6-9.6c1-1 2.5-1 3.4 0l5.6 5.6c1 1 1 2.5 0 3.4L13 21"/><path d="M22 21H7"/><path d="m5 11 9 9"/></svg>,
            Fill: () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M19 11.5a2.5 2.5 0 0 1 0 5H5.5a2.5 2.5 0 0 1 0-5H19Z"/><path d="m4 16.5 4.5 4.5"/><path d="m5 4 12.5 12.5"/><path d="M7 5.5a2.5 2.5 0 0 1 5 0V11"/></svg>,
            Dropper: () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="m2 22 1-1h3l9-9"/><path d="M3 21v-3l9-9"/><path d="m15 6 3.4-3.4a2.1 2.1 0 1 1 3 3L11.2 15.8"/><path d="m15 6 3 3"/><path d="m6.3 17.7 3-3"/></svg>,
            Grid: () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect width="18" height="18" x="3" y="3" rx="2"/><path d="M3 9h18"/><path d="M3 15h18"/><path d="M9 3v18"/><path d="M15 3v18"/></svg>,
            Download: () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" x2="12" y1="15" y2="3"/></svg>,
            Undo: () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M3 7v6h6"/><path d="M21 17a9 9 0 0 0-9-9 9 9 0 0 0-6 2.3L3 13"/></svg>,
            Upload: () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" x2="12" y1="3" y2="15"/></svg>,
            ZoomIn: () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="11" cy="11" r="8"/><line x1="21" x2="16.65" y1="21" y2="16.65"/><line x1="11" x2="11" y1="8" y2="14"/><line x1="8" x2="14" y1="11" y2="11"/></svg>,
            ZoomOut: () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="11" cy="11" r="8"/><line x1="21" x2="16.65" y1="21" y2="16.65"/><line x1="8" x2="14" y1="11" y2="11"/></svg>,
            Mouse: () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect x="5" y="2" width="14" height="20" rx="7"/><path d="M12 6v4"/></svg>,
            ResetView: () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/><path d="M3 3v5h5"/></svg>,
            Coffee: () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M18 8h1a4 4 0 0 1 0 8h-1"/><path d="M2 8h16v9a4 4 0 0 1-4 4H6a4 4 0 0 1-4-4V8z"/><line x1="6" y1="1" x2="6" y2="4"/><line x1="10" y1="1" x2="10" y2="4"/><line x1="14" y1="1" x2="14" y2="4"/></svg>,
            Globe: () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"/><path d="M12 2a14.5 14.5 0 0 0 0 20 14.5 14.5 0 0 0 0-20"/><path d="M2 12h20"/></svg>
        };

        const rgbToHex = (r, g, b) => "#" + ((1 << 24) + (r << 16) + (g << 8) + b).toString(16).slice(1);

        // --- Components ---
        function Modal({ isOpen, onClose, content }) {
            if (!isOpen) return null;
            return (
                <div className="fixed inset-0 z-[150] flex items-center justify-center bg-black/70 backdrop-blur-sm p-4">
                    <div className="bg-slate-800 border border-slate-700 rounded-2xl w-full max-w-2xl max-h-[80vh] flex flex-col shadow-2xl relative">
                        <button onClick={onClose} className="absolute top-4 right-4 text-slate-400 hover:text-white transition-colors">
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                        </button>
                        <div className="p-8 overflow-y-auto custom-scroll text-slate-300 space-y-4" dangerouslySetInnerHTML={{__html: content}} />
                    </div>
                </div>
            );
        }

        function BuyMeCoffeeQR({ t }) {
            return (
                <div className="relative group flex flex-col items-center gap-2">
                    <div className="w-12 h-12 bg-white p-0.5 rounded-lg shadow-lg flex items-center justify-center overflow-hidden border-2 border-slate-600 group-hover:border-[#FFDD00] cursor-pointer transition-colors">
                         <img src="https://api.qrserver.com/v1/create-qr-code/?size=150x150&data=https://buymeacoffee.com/snapglow" alt="QR" className="w-full h-full object-contain"/>
                    </div>
                    <span className="text-[10px] text-slate-400 font-bold group-hover:text-[#FFDD00] text-center leading-tight whitespace-pre-line">
                        {t('sponsor_scan')}
                    </span>
                    <div className="fixed left-20 bottom-4 w-56 h-56 bg-white p-4 rounded-xl shadow-2xl border-4 border-[#FFDD00] opacity-0 invisible group-hover:opacity-100 group-hover:visible transition-all duration-300 transform scale-90 group-hover:scale-100 origin-bottom-left flex flex-col items-center justify-center pointer-events-none group-hover:pointer-events-auto z-[100]">
                        <img src="https://api.qrserver.com/v1/create-qr-code/?size=300x300&data=https://buymeacoffee.com/snapglow" alt="Scan to Sponsor" className="w-full h-full object-contain"/>
                        <div className="absolute -top-3 bg-[#FFDD00] text-black text-xs font-bold px-3 py-1 rounded-full shadow-sm whitespace-nowrap">
                            {t('sponsor_thanks')}
                        </div>
                    </div>
                </div>
            );
        }

        function BuyMeCoffeeBanner({ t }) {
            return (
                <div className="w-full p-4 bg-slate-800/50 rounded-xl border border-dashed border-slate-700 hover:border-[#FFDD00] hover:bg-slate-800 transition-all group flex flex-col items-center gap-3 text-center">
                    <div className="w-10 h-10 bg-slate-700 rounded-full flex items-center justify-center group-hover:bg-[#FFDD00] group-hover:text-black transition-colors text-slate-400">
                        <Icons.Coffee />
                    </div>
                    <div>
                        <h3 className="text-sm font-bold text-slate-200 group-hover:text-white">{t('sponsor_title')}</h3>
                        <p className="text-[10px] text-slate-400 mt-1 leading-relaxed whitespace-pre-line">{t('sponsor_desc')}</p>
                    </div>
                    <a href="https://buymeacoffee.com/snapglow" target="_blank" className="w-full py-2 bg-[#FFDD00] hover:bg-[#ffea5c] text-black text-xs font-bold rounded-full shadow-lg hover:shadow-yellow-500/20 transition-all active:scale-95 flex items-center justify-center gap-2">
                        <Icons.Coffee /> {t('sponsor_btn')}
                    </a>
                </div>
            );
        }

        function App() {
            const [lang, setLang] = useState('zh-TW');
            const [dimensions, setDimensions] = useState({ width: 32, height: 32 });
            const [pixels, setPixels] = useState(Array(32 * 32).fill("")); 
            const [tool, setTool] = useState('pencil');
            const [selectedColor, setSelectedColor] = useState('#000000');
            const [recentColors, setRecentColors] = useState(['#000000', '#ffffff']);
            const [zoom, setZoom] = useState(20);
            const [panOffset, setPanOffset] = useState({ x: 0, y: 0 });
            const [showGrid, setShowGrid] = useState(true);
            const [history, setHistory] = useState([]);
            const [customW, setCustomW] = useState(64);
            const [customH, setCustomH] = useState(64);
            const [activeModal, setActiveModal] = useState(null);

            const canvasRef = useRef(null);
            const containerRef = useRef(null);
            const isDrawing = useRef(false);
            const isPanning = useRef(false);
            const lastMousePos = useRef({ x: 0, y: 0 });

            const t = (key) => TRANSLATIONS[lang][key] || key;

            const drawCanvas = useCallback(() => {
                const canvas = canvasRef.current;
                if (!canvas) return;
                const ctx = canvas.getContext('2d');
                canvas.width = dimensions.width;
                canvas.height = dimensions.height;
                ctx.clearRect(0, 0, dimensions.width, dimensions.height);
                pixels.forEach((color, i) => {
                    if (color) {
                        const x = i % dimensions.width;
                        const y = Math.floor(i / dimensions.width);
                        ctx.fillStyle = color;
                        ctx.fillRect(x, y, 1, 1);
                    }
                });
            }, [pixels, dimensions]);

            useEffect(() => { drawCanvas(); }, [drawCanvas]);

            const updateRecentColors = (color) => {
                setRecentColors(prev => {
                    const filtered = prev.filter(c => c !== color);
                    return [color, ...filtered].slice(0, 5);
                });
            };

            const resizeCanvas = (w, h) => {
                const newPixels = Array(w * h).fill("");
                setDimensions({ width: w, height: h });
                setPixels(newPixels);
                setHistory([]);
                setZoom(w > 64 ? 10 : 20);
                setPanOffset({ x: 0, y: 0 });
            };

            const saveHistory = () => {
                setHistory(prev => {
                    const newHist = [...prev, [...pixels]];
                    if (newHist.length > 30) newHist.shift();
                    return newHist;
                });
            };

            const handleUndo = () => {
                if (history.length === 0) return;
                const prevPixels = history[history.length - 1];
                setHistory(prev => prev.slice(0, -1));
                setPixels(prevPixels);
            };

            const handleWheel = (e) => {
                e.preventDefault();
                const delta = e.deltaY > 0 ? -1 : 1;
                const speed = 2;
                setZoom(prev => Math.max(1, Math.min(80, prev + (delta * speed))));
            };

            const handleMouseDown = (e) => {
                if (e.button === 2 || e.button === 1) {
                    isPanning.current = true;
                    lastMousePos.current = { x: e.clientX, y: e.clientY };
                    e.preventDefault();
                } else if (e.button === 0) {
                    isDrawing.current = true;
                    saveHistory();
                    if (tool === 'pencil' || tool === 'fill') updateRecentColors(selectedColor);
                    paint(e);
                }
            };

            const handleMouseMove = (e) => {
                if (isPanning.current) {
                    const dx = e.clientX - lastMousePos.current.x;
                    const dy = e.clientY - lastMousePos.current.y;
                    setPanOffset(prev => ({ x: prev.x + dx, y: prev.y + dy }));
                    lastMousePos.current = { x: e.clientX, y: e.clientY };
                    return;
                }
                if (isDrawing.current) paint(e);
            };

            const handleMouseUp = () => {
                isDrawing.current = false;
                isPanning.current = false;
            };

            const handleContextMenu = (e) => e.preventDefault();

            const getPixelIndex = (e) => {
                const canvas = canvasRef.current;
                const rect = canvas.getBoundingClientRect();
                const xRaw = e.clientX - rect.left;
                const yRaw = e.clientY - rect.top;
                const scaleX = dimensions.width / rect.width;
                const scaleY = dimensions.height / rect.height;
                const x = Math.floor(xRaw * scaleX);
                const y = Math.floor(yRaw * scaleY);
                if (x < 0 || x >= dimensions.width || y < 0 || y >= dimensions.height) return null;
                return y * dimensions.width + x;
            };

            const paint = (e) => {
                const idx = getPixelIndex(e);
                if (idx === null) return;
                const currentPixels = [...pixels];
                const targetColor = currentPixels[idx];

                if (tool === 'pencil') {
                    if (targetColor === selectedColor) return;
                    currentPixels[idx] = selectedColor;
                    setPixels(currentPixels);
                } else if (tool === 'eraser') {
                    if (targetColor === "") return;
                    currentPixels[idx] = "";
                    setPixels(currentPixels);
                } else if (tool === 'dropper') {
                    if (targetColor) {
                        setSelectedColor(targetColor);
                        updateRecentColors(targetColor);
                        setTool('pencil');
                    }
                } else if (tool === 'fill') {
                    if (targetColor === selectedColor) return;
                    const stack = [idx];
                    const w = dimensions.width;
                    while(stack.length) {
                        const curIdx = stack.pop();
                        const cx = curIdx % w;
                        const cy = Math.floor(curIdx / w);
                        if (currentPixels[curIdx] === targetColor) {
                            currentPixels[curIdx] = selectedColor;
                            if (cx > 0) stack.push(curIdx - 1);
                            if (cx < w - 1) stack.push(curIdx + 1);
                            if (cy > 0) stack.push(curIdx - w);
                            if (cy < dimensions.height - 1) stack.push(curIdx + w);
                        }
                    }
                    setPixels(currentPixels);
                    isDrawing.current = false;
                }
            };

            const resetView = () => {
                setPanOffset({ x: 0, y: 0 });
                setZoom(20);
            };

            // NEW: Modified Image Upload Handler
            const handleImageUpload = (e) => {
                const file = e.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (event) => {
                    const img = new Image();
                    img.onload = () => {
                        // 1. Calculate safe dimensions (Max 128px for performance)
                        const MAX_SIZE = 128;
                        let w = img.width;
                        let h = img.height;
                        
                        // Scale down if too big
                        if (w > MAX_SIZE || h > MAX_SIZE) {
                            const ratio = Math.min(MAX_SIZE / w, MAX_SIZE / h);
                            w = Math.floor(w * ratio);
                            h = Math.floor(h * ratio);
                        }

                        // 2. Prepare canvas
                        const tempCanvas = document.createElement('canvas');
                        const ctx = tempCanvas.getContext('2d');
                        tempCanvas.width = w;
                        tempCanvas.height = h;
                        
                        // 3. Draw image resized
                        ctx.drawImage(img, 0, 0, w, h);
                        
                        // 4. Extract pixel data
                        const data = ctx.getImageData(0, 0, w, h).data;
                        const newPixels = Array(w * h).fill("");
                        
                        for (let i = 0; i < data.length; i+=4) {
                            // Check alpha to detect transparency
                            if (data[i+3] > 50) { 
                                newPixels[i/4] = rgbToHex(data[i], data[i+1], data[i+2]);
                            }
                        }
                        
                        // 5. Update state
                        if(confirm(t('confirm_new'))) {
                            setDimensions({ width: w, height: h });
                            setPixels(newPixels);
                            setHistory([]); // Clear history
                            // Auto zoom to fit
                            const newZoom = Math.floor(500 / Math.max(w, h));
                            setZoom(Math.max(2, newZoom));
                            setPanOffset({ x: 0, y: 0 });
                        }
                    };
                    img.src = event.target.result;
                };
                reader.readAsDataURL(file);
                e.target.value = '';
            };

            const downloadImage = () => {
                const link = document.createElement('a');
                link.download = `pixel-art-${dimensions.width}x${dimensions.height}.png`;
                const exportCanvas = document.createElement('canvas');
                const scale = 20;
                exportCanvas.width = dimensions.width * scale;
                exportCanvas.height = dimensions.height * scale;
                const ctx = exportCanvas.getContext('2d');
                ctx.imageSmoothingEnabled = false;
                ctx.drawImage(canvasRef.current, 0, 0, exportCanvas.width, exportCanvas.height);
                link.href = exportCanvas.toDataURL('image/png');
                link.click();
            };

            return (
                <div className="h-screen flex flex-col overflow-hidden bg-[#0f172a] no-select">
                    {/* Top Network Nav */}
                    <NetworkNav />

                    {/* Header */}
                    <header className="bg-slate-900 border-b border-slate-800 p-3 flex justify-between items-center z-30 shrink-0 shadow-md">
                        <div className="flex items-center gap-4">
                            <h1 className="text-xl font-extrabold tracking-tight text-white flex items-center gap-2">
                                <span className="bg-indigo-600 rounded p-1">ğŸ¨</span>
                                {t('title')}
                            </h1>
                            <div className="hidden md:flex items-center gap-2 text-xs text-slate-400 bg-slate-800/50 px-3 py-1 rounded-full border border-slate-700">
                                <span>{dimensions.width} x {dimensions.height}</span>
                                <span className="w-px h-3 bg-slate-600"></span>
                                <span className="flex items-center gap-1"><Icons.Mouse/> {lang === 'zh-TW' ? 'å³éµæ‹–æ›³ / æ»¾è¼ªç¸®æ”¾' : 'Right-click Pan / Wheel Zoom'}</span>
                            </div>
                        </div>
                        <div className="flex items-center gap-3">
                            <button 
                                onClick={() => setLang(lang === 'zh-TW' ? 'en' : 'zh-TW')}
                                className="text-slate-400 hover:text-white flex items-center gap-1 text-xs font-bold transition-colors bg-slate-800 px-3 py-1.5 rounded-lg border border-slate-700 hover:border-indigo-500"
                            >
                                <Icons.Globe />
                                {lang === 'zh-TW' ? 'English' : 'ç¹é«”ä¸­æ–‡'}
                            </button>
                            <button onClick={downloadImage} className="bg-indigo-600 hover:bg-indigo-500 text-white px-5 py-2 rounded-lg text-sm font-bold flex items-center gap-2 transition-all shadow-lg hover:shadow-indigo-500/20 active:scale-95">
                                <Icons.Download /> {t('download')}
                            </button>
                        </div>
                    </header>

                    <div className="flex-1 flex overflow-hidden">
                        {/* LEFT: Tools */}
                        <aside className="w-16 sm:w-20 bg-slate-900 border-r border-slate-800 flex flex-col items-center py-6 gap-6 shrink-0 z-50 shadow-xl">
                            <div className="flex flex-col gap-3 w-full px-3">
                                <ToolBtn icon={<Icons.Pencil/>} active={tool==='pencil'} onClick={()=>setTool('pencil')} color="blue" tip={t('pencil')} />
                                <ToolBtn icon={<Icons.Eraser/>} active={tool==='eraser'} onClick={()=>setTool('eraser')} color="red" tip={t('eraser')} />
                                <ToolBtn icon={<Icons.Fill/>} active={tool==='fill'} onClick={()=>setTool('fill')} color="green" tip={t('fill')} />
                                <ToolBtn icon={<Icons.Dropper/>} active={tool==='dropper'} onClick={()=>setTool('dropper')} color="yellow" tip={t('dropper')} />
                            </div>
                            <div className="w-full px-4"><div className="h-px bg-slate-800"></div></div>
                            <div className="flex flex-col gap-3 items-center flex-1">
                                <div className="relative group">
                                    <input 
                                        type="color" 
                                        value={selectedColor} 
                                        onChange={(e) => {
                                            setSelectedColor(e.target.value);
                                            setTool('pencil');
                                        }}
                                        className="w-10 h-10 p-0 border-0 rounded-xl overflow-hidden cursor-pointer ring-2 ring-slate-700 group-hover:ring-indigo-500 transition-all shadow-lg"
                                    />
                                </div>
                                <div className="flex flex-col gap-2">
                                    {recentColors.slice(0, 5).map((c, i) => (
                                        <button 
                                            key={i} 
                                            style={{backgroundColor: c}}
                                            onClick={() => {setSelectedColor(c); setTool('pencil');}}
                                            className="w-6 h-6 rounded-md border border-slate-600 hover:scale-125 hover:border-white transition-all shadow-sm"
                                        />
                                    ))}
                                </div>
                            </div>
                            <div className="pb-4">
                                <BuyMeCoffeeQR t={t} />
                            </div>
                        </aside>

                        {/* CENTER: Canvas */}
                        <main className="flex-1 relative overflow-hidden flex flex-col bg-[#0f172a]">
                            <div className="absolute top-6 left-1/2 -translate-x-1/2 bg-slate-800/80 backdrop-blur-md border border-slate-600/50 p-1.5 rounded-full flex gap-3 items-center shadow-2xl z-30 pointer-events-auto">
                                <button onClick={handleUndo} disabled={history.length===0} className="p-2 hover:bg-white/10 rounded-full text-slate-200 disabled:opacity-30 transition-colors" title={t('undo')}>
                                    <Icons.Undo />
                                </button>
                                <div className="w-px h-5 bg-slate-600"></div>
                                <button onClick={() => setShowGrid(!showGrid)} className={`p-2 rounded-full transition-colors ${showGrid ? 'bg-indigo-500 text-white shadow-lg shadow-indigo-500/30' : 'text-slate-300 hover:bg-white/10'}`} title={t('grid')}>
                                    <Icons.Grid />
                                </button>
                                <div className="w-px h-5 bg-slate-600"></div>
                                <div className="flex items-center gap-2 px-2 text-slate-300">
                                    <Icons.ZoomOut />
                                    <input 
                                        type="range" 
                                        min="1" 
                                        max="80" 
                                        value={zoom} 
                                        onChange={(e) => setZoom(Number(e.target.value))}
                                        className="w-24 h-1 bg-slate-600 rounded-lg appearance-none cursor-pointer accent-indigo-500"
                                    />
                                    <Icons.ZoomIn />
                                </div>
                                <div className="w-px h-5 bg-slate-600"></div>
                                <button onClick={resetView} className="p-2 hover:bg-white/10 rounded-full text-slate-200 transition-colors" title={t('reset')}>
                                    <Icons.ResetView />
                                </button>
                            </div>

                            <div 
                                ref={containerRef}
                                className={`w-full h-full checkerboard flex items-center justify-center overflow-hidden relative cursor-draw`}
                                onContextMenu={handleContextMenu}
                                onMouseDown={handleMouseDown}
                                onMouseMove={handleMouseMove}
                                onMouseUp={handleMouseUp}
                                onMouseLeave={handleMouseUp}
                                onWheel={handleWheel}
                            >
                                <div 
                                    className="relative shadow-2xl bg-white origin-center will-change-transform shrink-0" 
                                    style={{
                                        width: dimensions.width * zoom,
                                        height: dimensions.height * zoom,
                                        transform: `translate(${panOffset.x}px, ${panOffset.y}px)`, 
                                        backgroundImage: showGrid ? `
                                            linear-gradient(rgba(0,0,0,0.1) 1px, transparent 1px),
                                            linear-gradient(90deg, rgba(0,0,0,0.1) 1px, transparent 1px)
                                        ` : 'none',
                                        backgroundSize: `${zoom}px ${zoom}px`,
                                        imageRendering: 'pixelated'
                                    }}
                                >
                                    <canvas 
                                        ref={canvasRef}
                                        style={{
                                            width: '100%',
                                            height: '100%',
                                            imageRendering: 'pixelated',
                                            display: 'block',
                                            pointerEvents: 'none'
                                        }}
                                    />
                                </div>
                            </div>
                        </main>

                        {/* RIGHT: Settings */}
                        <aside className="w-64 bg-slate-900 border-l border-slate-800 p-6 flex flex-col gap-6 shrink-0 overflow-y-auto z-20 shadow-xl">
                            <div>
                                <h3 className="text-xs text-slate-500 font-bold uppercase tracking-wider mb-4 flex items-center gap-2">
                                    {t('quick_size')}
                                </h3>
                                <div className="grid grid-cols-2 gap-2">
                                    {[32, 64, 96, 128].map(s => (
                                        <button 
                                            key={s}
                                            onClick={() => {
                                                if(confirm(t('confirm_new'))) resizeCanvas(s, s);
                                            }}
                                            className="bg-slate-800 hover:bg-slate-700 text-slate-300 py-3 rounded-lg text-xs font-bold font-mono transition-all border border-slate-700 hover:border-indigo-500 hover:text-white"
                                        >
                                            {s}x{s}
                                        </button>
                                    ))}
                                </div>
                            </div>

                            <div className="bg-slate-800/50 p-4 rounded-xl border border-slate-800">
                                <h3 className="text-xs text-slate-500 font-bold uppercase tracking-wider mb-3">{t('custom_size')}</h3>
                                <div className="flex gap-2 items-center mb-3">
                                    <input 
                                        type="number" 
                                        value={customW}
                                        onChange={(e) => setCustomW(Math.min(256, Number(e.target.value)))}
                                        className="w-full bg-slate-900 border border-slate-600 rounded p-2 text-center text-sm focus:border-indigo-500 outline-none text-white font-mono" 
                                        placeholder={t('width')}
                                    />
                                    <span className="text-slate-500 font-bold">Ã—</span>
                                    <input 
                                        type="number" 
                                        value={customH}
                                        onChange={(e) => setCustomH(Math.min(256, Number(e.target.value)))}
                                        className="w-full bg-slate-900 border border-slate-600 rounded p-2 text-center text-sm focus:border-indigo-500 outline-none text-white font-mono"
                                        placeholder={t('height')}
                                    />
                                </div>
                                <button 
                                    onClick={() => {
                                        if(customW > 0 && customH > 0) {
                                            if(confirm(t('confirm_new'))) resizeCanvas(customW, customH);
                                        }
                                    }}
                                    className="w-full bg-slate-700 hover:bg-indigo-600 text-white py-2 rounded-lg text-sm font-bold transition-all"
                                >
                                    {t('create')}
                                </button>
                            </div>

                             <div>
                                <h3 className="text-xs text-slate-500 font-bold uppercase tracking-wider mb-3">{t('upload_title')}</h3>
                                <label className="flex flex-col items-center justify-center w-full h-24 border-2 border-slate-700 border-dashed rounded-xl cursor-pointer hover:bg-slate-800/50 hover:border-indigo-500/50 transition-all group">
                                    <div className="flex flex-col items-center justify-center pt-5 pb-6">
                                        <div className="text-slate-500 group-hover:text-indigo-400 mb-2"><Icons.Upload /></div>
                                        <p className="text-xs text-slate-500 group-hover:text-slate-300 font-medium">{t('upload_desc')}</p>
                                    </div>
                                    <input type="file" className="hidden" accept="image/*" onChange={handleImageUpload} />
                                </label>
                            </div>

                            <div className="mt-auto flex flex-col gap-4">
                                <div className="border-t border-slate-800 pt-4">
                                    <BuyMeCoffeeBanner t={t} />
                                </div>
                                
                                <div className="flex flex-wrap justify-center gap-x-4 gap-y-2 text-[10px] text-slate-500 pt-2 pb-2">
                                    <button onClick={() => setActiveModal('privacy')} className="hover:text-slate-300 transition-colors hover:underline">
                                        {t('footer_privacy')}
                                    </button>
                                    <button onClick={() => setActiveModal('terms')} className="hover:text-slate-300 transition-colors hover:underline">
                                        {t('footer_terms')}
                                    </button>
                                    <button onClick={() => setActiveModal('contact')} className="hover:text-slate-300 transition-colors hover:underline">
                                        {t('footer_contact')}
                                    </button>
                                </div>
                            </div>
                        </aside>
                    </div>

                    <Modal 
                        isOpen={!!activeModal} 
                        onClose={() => setActiveModal(null)} 
                        content={activeModal ? LEGAL_CONTENT[lang][activeModal] : ''}
                    />
                </div>
            );
        }

        function ToolBtn({ icon, active, onClick, color, tip }) {
            const colors = {
                blue: 'hover:bg-blue-500/20 hover:text-blue-400',
                red: 'hover:bg-red-500/20 hover:text-red-400',
                green: 'hover:bg-emerald-500/20 hover:text-emerald-400',
                yellow: 'hover:bg-amber-500/20 hover:text-amber-400',
            };
            const activeColors = {
                blue: 'bg-blue-600 text-white shadow-lg shadow-blue-500/30 ring-1 ring-blue-400',
                red: 'bg-red-600 text-white shadow-lg shadow-red-500/30 ring-1 ring-red-400',
                green: 'bg-emerald-600 text-white shadow-lg shadow-emerald-500/30 ring-1 ring-emerald-400',
                yellow: 'bg-amber-600 text-white shadow-lg shadow-amber-500/30 ring-1 ring-amber-400',
            };

            return (
                <button 
                    onClick={onClick}
                    title={tip}
                    className={`w-full aspect-square rounded-xl flex items-center justify-center transition-all duration-200 ${active ? `${activeColors[color]} scale-105` : `text-slate-400 ${colors[color]} bg-slate-800/50`}`}
                >
                    {icon}
                </button>
            )
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
